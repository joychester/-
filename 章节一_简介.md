## 1. 简介  

> 
> - *写小说有三个准则。很不幸，没人知道它们是什么。——萨默塞特·毛姆(Somerset Maugham)*  
> - *如果你不知道你要去哪里，你千万要小心，因为你可能永远也到不了那里。——尤吉·贝拉(Yogi Berra)*  
> - *我之所以能看的更远，是因为我站在了巨人的肩膀上。——伯尔纳铎(Bernard of Chartres)*  
> - *莎士比亚因为懂的不多而写出了更美的诗歌；米尔顿...因为知道太多反而毁了他的诗歌。——A.N.怀特海德(A.N. Whitehead)*    
>  

设计一个计算机系统与设计一个算法截然不同，一般来说设计一个计算机系统： 
- 其对外接口(或需求)更加复杂，模棱两可且易变  
- 其内部会由更多的子系统或模块组成，因此会有更多的内部接口  
- 很难衡量其是否是更优秀的设计  

设计者一开始往往会有种力不从心，盲人摸象的感觉，不确定某一种选择会不会限制或阻碍到其他的选择，甚至可能会影响到整个系统的容量和性能。也许现实中就不存在一个最优的整体解决方案, 甚至部分也没有*。 这篇文章希望强调的一点是，做设计时，尽可能使内部系统之间泾渭分明，从而避免采用糟糕的解决方案。 

我曾经设计和构建了许多计算机系统，有些成功了，有些却没有。我也曾使用和研究过其他人设计的系统，也是喜忧参半。从这些亲身经历中，我整理出来一些设计优秀系统时通用的设计建议和准则。其中大部分是资深设计者的经验之谈，然而俗话说的好，“人们更能接受善意的提醒而不是被说教，这一点往往会被忽略”。这里会讲到一些普世的原则(比如抽象和模块)，也会用一些反面教材帮助我们从不同的角度去理解怎么做才是对的。

我将这些原则通过三个经典的问题(What? How? When, Who?)从三个维度，用一句话简短的话来概括: __*STEADY by AID with ART*__:
> 
> - *What? 目标 STEADY：Simple(简单明了)，Timely(及时的)，Efficient(高效的)，Adaptable(灵活的)，Dependable(可靠的)，Yummy(有品味的)*  
> - *How? 对策 by AID：Approximate(效仿)，Incremental(迭代)，Divide&Conquer(分而治之)*  
> - *When，who? 流程 with ART：Architecture(架构)，Automate(自动化)，Review(审查)，Techniques(技巧)，Test(测试)*     
>  

做系统设计时，人们常常会考虑诸多建议，但其中最为重要的几条建议如下：
> - 简单明了 (Keep it simple)
> - 撰写文档 (Write a spec)
> - 模块化设计 (Design with independent modules)
> - 追求高效 (Exploit the ABCs of effiency)
> - 理解状态的本质 (Treat state as both being and becoming)
> - 利用最终一致性模型实现数据本地化 (Use eventual consistency to keep data local)

以上这些仅仅是建议而已。它们不是科幻小说(但也有一些是例外，魔力无穷)，并不保证万无一失，药到病除，一层不变，也不是经过精确演算得到的科学公式，更没有经过所有牛人们的一致认可。要学会去辨别剔除那些对你没有帮助，甚至适得其反的条目。

这篇文章会以一堆反义词开头(简单的与复杂的，指令式与声明式，等等)，来帮助你认清设计系统时的优先顺序和组织结构。第二章主要讲诉一些原则，比如：抽象，说明文档，编码，模块化以及拥有自己主见的重要性。第三章里，首先会在每一节把实现每一个目标的方法与技巧描述清楚，其次会介绍一个比较通用的迭代方法。截止到目前，“高效的”这一次提到的最多，其次是“可靠的”，主要是因为，“局部性原则”和“并发”可以归为“高效的”话题，而“冗余”则属于“可靠性”的范畴，这三架马车(locality, concurrency, redundancy)在当今的系统设计中至关重要。在第四章里，我会简短的讨论一下非技术领域中的流程话题，然后在第五章中会讨论每一组反义词。在整个讨论过程中，你会看到各种毫无违和感的广告语，也会看到各种吐槽的名言警句。

文章会采用大量的实例去解释以上观点；我尽量选择那些广为人知和通熟易懂的例子。如果能找到一个可以将问题描述清楚的案例，那将会极大的帮助你找到解决问题的方法。我也会花点时间讲故事(用`>>`和小字体来标记)。很多内容会被多处地方引用，我都会将它标记出来，并写在索引里，方便查阅。第一次出现的术语我也会用斜体标记，你可以上网搜索它的来历和意义。有些条目我感觉网上也很难搜到准确的定义，不用担心，这种情况我会加上我的注释。

我担心我的文章晦涩难懂，不够深入浅出 (这意味着你需要仔细认真的思考才能理解我在说什么)。我在这篇精简版中删掉了很多细节和注意事项。如果我不这么做，这篇文章可能一千多页也写不完。如果你觉得精简版不够过瘾，可以试试完整版。

### 1.1 反义词和广告语
>  
> - *我现在学会了如何辩证的看待生活 ——琼尼·米歇尔(Joni Mitchell)*  
>  

学会从正反两个方面思考会对理解系统设计有很大帮助。它们的关系并非水火不容，而是可以反映出思考问题的广度。下面列举了一些有用的例子，每一个都会对应一段广告语(有些是在故意说反话，你懂的)，来概括它的含义。我把他们按照优先级排序，并在第五章会继续讨论详细内容： 

| 目标 | 反义词 | 广告语 |
| --- | --- | --- |
| 原则 | 设计文档 <--> 代码| 编写文档。精确无误。简明扼要。面面俱到。剩下的交给客户。 | 
| 简单明了 | 简明 <--> 啰嗦，轮廓<-->特征，笼统<-->具体| KISS：让傻瓜都能理解你的设计。不要太过笼统。专注做好一件事。不要掩藏实力。追求性能。暴力破解。 | 
|  | 完美 <--> 差不多，严格 <--> 宽松| 恰到好处。不完美的解决方案也比完美但无法实现的方案强的多。松散而有弹性的组件。 |
|  | 设计文档 <--> 代码| 隐藏秘密。 |
|  | 指令式 <--> 函数式 <--> 声明式|  |
| 及时的 | dasd | 苏打苏打 | 
| 高效的 | dasd | 苏打苏打 | 
| 灵活的 | dasd | 苏打苏打 | 
| 可靠的 | dasd | 苏打苏打 | 
| 迭代 | dasd | 苏打苏打 | 
| 流程 | dasd | 苏打苏打 | 